{% extends 'base.html' %}
{% from 'host/common.html' import edit_field %}

{% macro common_schedule_install_gui() %}

{{ edit_field(form.install_action, style="width: 100%", multiple="multiple", field_width="col-sm-6", class="form-control") }}

<div id="software-packages-panel">
    
  <div class="form-group ">
    <label class="col-sm-4 control-label">Select From</label>
    <div class=col-sm-8> 
      <div>
        <span id="install-add-widget-panel">
          <a id="browse-repository-button" href="javascript://">
            <img src="/static/browse_server.png">&nbsp;Server Repository
          </a>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <a id="browse-cisco-button" href="javascript://">
            <img src="/static/internet.png">&nbsp;Cisco.com
          </a>  
        </span> 
      </div>
      <div>
        <span id="activate-widget-panel">
          <a id="browse-inactive-software-button" href="javascript://">
            <img src="/static/router_software.png">&nbsp;&nbsp;&nbsp;Inactive Packages
          </a>  
          &nbsp;&nbsp;&nbsp;&nbsp;
          <a id="browse-install-history-button" href="javascript://">
           <img src="/static/history.png">&nbsp;&nbsp;Install History
          </a>    
        </span> 
      </div>
    </div>
  </div>
  
  <div class="form-group ">
    <label class="col-sm-4 control-label" for="software_packages">{{ form.software_packages.label() }}</label>         
    <div class="col-sm-6">
      <textarea spellcheck="false" class="form-control" rows="5" id="software-packages" name="software_packages">{{ form.software_packages.data | none2blank }}</textarea>
    </div>
  </div>
   
</div> 
  
<div class="form-group ">
  <label class="col-sm-4 control-label" for="{{ form.scheduled_time.name }}">{{ form.scheduled_time.label() }}</label>
  <div class="col-sm-6">
    <div  class="input-group date form_datetime">
      <input id="scheduled-time" name="{{ form.scheduled_time.name }}" class="form-control" size="16" type="text" readonly>
      <input id="scheduled-time-UTC" name="{{ form.scheduled_time_UTC.name }}" value="{{ form.scheduled_time_UTC.data }}" class="form-control" type="hidden">
      <span class="input-group-addon DodgerBlue"><span class="glyphicon glyphicon-calendar"></span></span>
    </div>
  </div>
</div>

<div id="dependency-panel">
  {{ edit_field(form.dependency, field_width="col-sm-6", class="form-control") }}
</div>

<div id="server-repository-panel">      
  <div class="form-group ">
    <div class="col-sm-offset-4 col-sm-6">
      <div id="accordion" class="panel-group">
        <div id="server-repository-info-panel" class="panel-collapse collapse">
          <div id="server-repository-info" class="panel-body well"></div>
        </div>
      </div>
    </div>   
  </div>
</div>

<input id="hidden_server" name="{{ form.hidden_server.name }}" value="{{ form.hidden_server.data }}" type="hidden">
<input id="hidden_server_name" name="{{ form.hidden_server_name.name }}" value="{{ form.hidden_server_name.data }}" type="hidden">
<input id="hidden_server_directory" name="{{ form.hidden_server_directory.name }}" value="{{ form.hidden_server_directory.data }}" type="hidden">
<input id="hidden_pending_downloads" name="{{ form.hidden_pending_downloads.name }}" value="{{ form.hidden_pending_downloads.data }}" type="hidden">

{% endmacro %}

{% block extra_head %}
<script src="/static/bootbox-4.2.0/js/bootbox.js"></script>
<script src="/static/datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<link rel="stylesheet" href="/static/datetimepicker/css/bootstrap-datetimepicker.min.css">
<script src="/static/duallistbox/dist/dual-list-box.js"></script>
<script src="/static/jquery-cookie-master/jquery.cookie.js"></script>
<script src="/static/jquery/js/smu_info_dialog.js"></script>
<script src="/static/jquery-cookie-master/jquery.cookie.js"></script>

<style>
  .modal-dialog {    
    width: 900px;
  }
  a:link, a:visited {
   text-decoration:none;
  }
</style>

<script type="text/javascript">
  $(function() { 
    
    var PRE_UPGRADE = "Pre-Upgrade";
    var INSTALL_ADD = "Install Add";
    var ACTIVATE = "Activate";
    var POST_UPGRADE = "Post-Upgrade";
    var INSTALL_COMMIT = "Install Commit";
    var ALL = "ALL"; 
    
    var current_region_id = -1;
    var browse_spinner = $('.browse-spinner');
    var submit_spinner = $('#submit-spinner');

    browse_spinner.hide();
    submit_spinner.hide();
    
    $("#install_action").select2({ placeholder: 'Select Desirable Install Actions' });

    // Software selected from server repository
    var server_software_selector = $('#server-software-selector').DualListBox();
    
    // Software selected from inactive packages
    var inactive_software_selector = $('#inactive-software-selector').DualListBox();
   
    if ($('#hidden_server').val() != -1) {
      display_selected_server_info($('#hidden_server_name').val(), $('#hidden_server_directory').val()); 
    }
    
    $('#install_action').on('change', function(e) {
      var install_actions = $('#install_action').val();
      if (has_one_of_these(install_actions, [ALL])) {
        $("#install_action").val([PRE_UPGRADE, INSTALL_ADD, ACTIVATE, POST_UPGRADE, INSTALL_COMMIT]).trigger('change');
      }
      // Use $('#install_action').val() to get the latest value
      toggle_ui($('#install_action').val());

    });
  
  
    $('#install_action').val(function(index, currentValue) {
      toggle_ui($(this).val());
      return currentValue
    });  

    function has_one_of_these(install_actions, search_items) {
      if (install_actions != null) {
        for (i = 0; i < install_actions.length; i++) {
           if ($.inArray(install_actions[i], search_items) > -1) {
             return true;
           }         
        }
      }
      return false;
    }
    
    function has_one_of_these_only(install_actions, search_items) {
      if (install_actions != null) {
        for (i = 0; i < install_actions.length; i++) {
           if ($.inArray(install_actions[i], search_items) == -1) {
             return false;
           }         
        }
        return true;
      }
      return false;
    }

    function toggle_ui(install_actions) {
      $('#install-add-widget-panel').hide();
      $('#activate-widget-panel').hide();
      $('#software-packages-panel').hide();
      $('#server-repository-panel').hide();
      
      if (install_actions == null ||
        has_one_of_these_only(install_actions, [PRE_UPGRADE, POST_UPGRADE, INSTALL_COMMIT])) {
        $('#software-packages-panel').hide();
      } 
      
      if (has_one_of_these(install_actions, [INSTALL_ADD]) &&
          has_one_of_these(install_actions, [ACTIVATE]) ) {
        $('#software-packages-panel').show();
        $('#server-repository-panel').show();
        $('#install-add-widget-panel').show();
        $('#activate-widget-panel').show();
      } else if (has_one_of_these(install_actions, [INSTALL_ADD]) ) {
        $('#software-packages-panel').show();
        $('#server-repository-panel').show();
        $('#install-add-widget-panel').show();
      } else if (has_one_of_these(install_actions, [ACTIVATE])) {
        $('#software-packages-panel').show();
        $('#activate-widget-panel').show();
      }
      
      if (install_actions != null && install_actions.length > 1) {
        $('#dependency').val(-1);
        $('#dependency-panel').hide();
      } else {
        $('#dependency-panel').show();
      }
    }

    $(".form_datetime").datetimepicker({
      format: "mm/dd/yyyy HH:ii P",
      showMeridian: true,
      autoclose: true,
      todayBtn: true,
      pickerPosition: "top-left",
      todayHighlight: true
    });

    function read_server_cookie(region_id) {
      if (region_id != -1) {
        var server = $.cookie('region-' + region_id + '-server');
        var server_directory = $.cookie('region-' + region_id + '-server-directory');
        
        $('#hidden_server').val(server == null ? -1 : server);
        $('#hidden_server_directory').val(server_directory == null ? '' : server_directory);
        
        //alert(server + ' ' + server_directory);
      }
    }
    
    function write_server_cookie(region_id, server, server_directory) {
      if (region_id != -1) {
        $.cookie('region-' + region_id + '-server', server, { path: '/' });  
        $.cookie('region-' + region_id + '-server-directory', server_directory, { path: '/' });  
      }
    }
    
    function display_server_repository_dialog(region_id) {
      current_region_id = region_id;
      read_server_cookie(region_id);
      
      $('#server-repository-dialog').modal({ show: true, backdrop:'static' })  

      var server_id = $('#hidden_server').val();
      var server_directory = $('#hidden_server_directory').val();
      if (server_id != -1) {
        $('#server_dialog_server').val(server_id);
        retrieve_file_list(server_id, $('#server_dialog_server_directory'), server_directory);
      }
    }

    function retrieve_file_list(server_id, server_directory_selector, server_directory) {

      server_directory_selector.html('');
      server_directory_selector.append('<option value="' + server_directory + '">' + server_directory + '</option>');

      browse_spinner.show();

      $.ajax({
        url: "/api/get_server_file_dict/" + server_id,
        dataType: 'json',
        data: {
          server_directory: server_directory
        },
        success: function(response) {
          if (response.status == 'Failed') {
            bootbox.alert("Either the server repository is not reachable or server directory does not exist.");
          } else {
            $.each(response, function(index, element) {
              populate_file_list(element, server_directory_selector, server_directory);
            });
          }

          browse_spinner.hide();
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          bootbox.alert("Unable to list files. Error=" + errorThrown);
          browse_spinner.hide();
        }
      });
    }

    function populate_file_list(element, server_directory_selector, server_directory) {

      var software_packages = get_software_package_list(); 

      var available_software = [];
      var selected_software = [];

      server_software_selector.initialize(available_software, selected_software);

      for (i = 0; i < element.length; i++) {
        var filename = element[i].filename;
        var is_directory = element[i].is_directory;

        if (is_directory == true) {
          server_directory_selector.append('<option value="' + filename + '">' + filename + '</option>');
        } else {
          // If we are on the same directory as previous selected, re-display the selected packages  
          if ($('#server_directory').val() == server_directory_selector.val()) {
            if ($.inArray(filename, software_packages) == -1) {
              available_software.push({
                'id': filename,
                'name': filename
              });
            } else {
              selected_software.push({
                'id': filename,
                'name': filename
              });
            }
          } else {
            available_software.push({
              'id': filename,
              'name': filename
            });
          }
        }
      }
      server_software_selector.initialize(available_software, selected_software);
    }

    // These are the selected packages in the textarea
    function get_software_package_list() {
      software_packages = new Array();

      // Copy the selected packages from the textarea to the duallistbox
      var lines = $('#software-packages').val().split('\n');
      $.each(lines, function() {
        var line = this.trim();
        if (line.length > 0) {
          software_packages.push(line);
        }
      });
      return software_packages;
    }

    $('#server_dialog_server').on('change', function(e) {
      server_id = $('#server_dialog_server').val();
      if (server_id == -1) {
        $('#server_dialog_server_directory').html('');
      } else {
        retrieve_file_list(server_id, $('#server_dialog_server_directory'), '')
      }
    });

    $('#server_dialog_server_directory').on('change', function(e) {
      retrieve_file_list(
        $('#server_dialog_server').val(), 
        $('#server_dialog_server_directory'), 
        $('#server_dialog_server_directory').val() );
    });
    
    $('#cisco_dialog_server').on('change', function(e) {
      server_id = $('#cisco_dialog_server option:selected').val();
      if (server_id == -1) {
        $('#cisco_dialog_server_directory').html('');
      } else {
        retrieve_file_list(server_id, $('#cisco_dialog_server_directory'), '')
      }
    });

    $('#cisco_dialog_server_directory').on('change', function(e) {
      retrieve_file_list(
        $('#cisco_dialog_server').val(), 
        $('#cisco_dialog_server_directory'), 
        $('#cisco_dialog_server_directory').val() );
    });

    // Move up one folder (i.e. parent folder)   
    $('#server-dialog-move-up').on('click', function(e) {
      retrieve_file_list(
        $('#server_dialog_server').val(), 
        $('#server_dialog_server_directory'), 
        get_parent_folder($('#server_dialog_server_directory').val()) );
    });
    
    $('#server-dialog-reset-server-directory').on('click', function(e) {
      reset_server_directory(
        $('#server_dialog_server').val(),
        $('#server_dialog_server_directory'), 
        $('#server_dialog_server_directory').val() );
    });

    $('#cisco-dialog-move-up').on('click', function(e) {
      retrieve_file_list(
        $('#cisco_dialog_server').val(), 
        $('#cisco_dialog_server_directory'), 
        get_parent_folder($('#cisco_dialog_server_directory').val()) );
    });
    
    $('#cisco-dialog-reset-server-directory').on('click', function(e) {
      reset_server_directory(
        $('#cisco_dialog_server').val(),
        $('#cisco_dialog_server_directory'),
        $('#cisco_dialog_server_directory').val() );
    });


    function reset_server_directory(server_id, server_directory_selector, server_directory) {
      if (server_directory != '') {    
        bootbox.confirm('Reset the server directory to use the server repository base directory?', function(result) {
          if (result) {
            retrieve_file_list(server_id, server_directory_selector, '')
          }
        });
      }
    }

    $('#on-server-repository-dialog-submit').click(function(e) {

      if ($('#server_dialog_server').val() == -1) {
        bootbox.alert("Server Repository has not been specified.");
        return false;
      }
      
      update_software_packages(server_software_selector.get_selected_items());

      // Record the newly selected server repository
      $('#hidden_server').val($('#server_dialog_server').val());
      $('#hidden_server_name').val($('#server_dialog_server option:selected').text());
      $('#hidden_server_directory').val($('#server_dialog_server_directory').val());
      
      write_server_cookie(current_region_id, $('#hidden_server').val(), $('#hidden_server_directory').val());
                 
      display_selected_server_info($('#hidden_server_name').val(), $('#hidden_server_directory').val());    
    });

    server_time_as_locale_time = convertToLocaleString("{{ server_time | datetime_string }}");

    // Called when the Schedule (i.e. submit) button is clicked but before the
    // form actually being submitted.  Returning false will stop the submission.
    $('#on-submit').click(function(e) {

      var install_actions = $('#install_action').val();
      if (install_actions == null) {
        bootbox.alert("Install Action has not been specified.");
        return false;
      }

      var server_id = $('#hidden_server').val();
      var software_packages = $('#software-packages').val().trim();

      if (has_one_of_these(install_actions, [INSTALL_ADD]) && server_id == -1) {
        bootbox.alert("Server repository has not been specified.");
        return false;
      }
      
      if (has_one_of_these(install_actions, [INSTALL_ADD]) && software_packages.length == 0) {
        bootbox.alert("Software packages has not been specified.");
        return false;
      }

      if (has_one_of_these(install_actions, [INSTALL_ADD]) && trim_lines(software_packages).split('\n').length > 16) {
        bootbox.alert("Due to the limitation of the Install Manager on the device, it can only handle a maximum of 16 software packages at a time.  To circumvent this issue, use a tar archive file instead.");
        return false;
      }

      $('#scheduled-time-UTC').val(convertToUTCString($('#scheduled-time').val()));

      return true;
    });

    // Convert the UTC time to Locale time
    $('#scheduled-time-UTC').val(function(index, value) {
      if (value == 'None' || value.length == 0) {
        $('#scheduled-time').val(server_time_as_locale_time);
      } else {
        $('#scheduled-time').val(convertToLocaleString(value));
      }
    });

    // Called by the $('#form').submit() function.
    function on_final_submit(current_form, hostname) {

      var install_actions = $('#install_action').val();
      var software_packages = $('#software-packages').val();
      
      if (has_one_of_these(install_actions, [INSTALL_ADD]) && 
          software_packages.indexOf('.tar') == -1) {
      
        var validate_object = {
          form: current_form,
          hostname: hostname,
          server_id: $('#hidden_server').val(),
          server_directory: $('#hidden_server_directory').val(),
          software_packages: software_packages,
          spinner: submit_spinner,
          check_missing_file_on_server: true,
          callback: on_finish_validate
        };

        on_validate_prerequisites_and_files_on_server(validate_object);
        
      } else {
        current_form.submit();
      }
    }

    function on_finish_validate(validate_object) {
      $('#software-packages').val(validate_object.software_packages);
      $('#hidden_pending_downloads').val(validate_object.pending_downloads);
      validate_object.form.submit();
    }

    /*-- Code to support Cisco Browsing --*/
    var filter_option = $.cookie('platforms-and-releases-filter-option') == null ? 'Optimal' : $.cookie('platforms-and-releases-filter-option');
    $("#filter-selector option[value='" + filter_option + "']").attr('selected', 'selected');

    var platform = '';
    var release = '';

    $('#smu-list-tab').tab();
    $('#smu-list-tab a:first').tab('show');

    // The SP table has problem with the table layout
    $('#smu-list-tab a[href="#sp-tab"]').click(function() {
      setTimeout(function() {
        refresh_sp_list_table();
      }, 300);
    });

    // Sets the correct filter icon color
    toggle_filter_icon_color(filter_option);

    $('#filter-selector').on('change', function(e) {
      filter_option = $(this).val();
      $.cookie('platforms-and-releases-filter-option', filter_option);
      toggle_filter_icon_color(filter_option);
      refresh_tables();
    });

    function refresh_tables() {
      if (platform.length > 0 && release.length > 0) {
        $('#platform-and-release').html(beautify_platform(platform) + "-" + release + " > SMUs &nbsp;");
        browse_spinner.show();
        refresh_smu_list_table();
        refresh_sp_list_table();
      }
    }

    function toggle_filter_icon_color(filter_option) {
      if (filter_option == 'Optimal') {
        $('#filter-icon').addClass("DarkGreen");
        $('#filter-icon').removeClass("Red");
      } else {
        $('#filter-icon').removeClass("DarkGreen");
        $('#filter-icon').addClass("Red");
      }
    }

    var smu_table = $("#smu-datatable").dataTable({
      "order": [
        [1, "desc"]
      ],
      "scrollX": true,
      "scrollY": 400,
      "pageLength": 100,
      "fnCreatedRow": function( nRow, aData, iDataIndex ) {  
          var date_diff = date_diff_in_days(new Date($('td:eq(1)', nRow).text()), new Date() );         
          if (date_diff <= 7) {
            $('td', nRow).css('background-color', '#FFFFCC');
          }
        },
      "columnDefs": [{
        "targets": 0,
        "data": 'package_name',
        "render": function(data, type, row) {
          return '<input type="checkbox" value="' + data + '" class="check">';
        }
      }, {
        "targets": 1,
        "data": 'posted_date'
      }, {
        "targets": 2,
        "data": 'id',
        "render": function(data, type, row) {
          return '<a class="show-smu-details" smu_id="' + data + '" href="javascript://">' + data + '</a>'
        }
      }, {
        "targets": 3,
        "data": 'ddts_url'
      }, {
        "targets": 4,
        "data": 'type'
      }, {
        "targets": 5,
        "width": "42%",
        "data": 'description'
      }, {
        "targets": 6,
        "width": "10%",
        "data": 'impact'
      }, {
        "targets": 7,
        "width": "10%",
        "data": 'functional_areas'
      }, {
        "targets": 8,
        "data": 'status'
      }, {
        "targets": 9,
        "width": "20%",
        "data": 'package_bundles'
      }, ],

    }).on('draw.dt', function(e, settings, json) {
      var rows = 0;
      if (smu_table.api().ajax.json() != null) {
        rows = smu_table.api().ajax.json().data.length;
      }
      
      $('#badge-smu-list').html(rows);
      browse_spinner.hide();
    });

    var sp_table = $("#sp-datatable").dataTable({
      "order": [
        [1, "desc"]
      ],
      "scrollX": true,
      "scrollY": 400,
      "pageLength": 100,
      "fnCreatedRow": function( nRow, aData, iDataIndex ) {  
        var date_diff = date_diff_in_days(new Date($('td:eq(1)', nRow).text()), new Date() );        
        if (date_diff <= 7) {
          $('td', nRow).css('background-color', '#FFFFCC');
        }
      },
      "columnDefs": [{
        "targets": 0,
        "data": 'package_name',
        "render": function(data, type, row) {
          return '<input type="checkbox" value="' + data + '" class="check">';
        }
      }, {
        "targets": 1,
        "data": 'posted_date'
      }, {
        "targets": 2,
        "data": 'id',
        "render": function(data, type, row) {
          return '<a class="show-smu-details" smu_id="' + data + '" href="javascript://">' + data + '</a>'
        }
      }, {
        "targets": 3,
        "data": 'ddts_url'
      }, {
        "targets": 4,
        "data": 'type'
      }, {
        "targets": 5,
        "width": "42%",
        "data": 'description'
      }, {
        "targets": 6,
        "width": "10%",
        "data": 'impact'
      }, {
        "targets": 7,
        "data": 'functional_areas'
      }, {
        "targets": 8,
        "data": 'status'
      }, {
        "targets": 9,
        "width": "9%",
        "data": 'package_bundles'
      }, ],
    }).on('draw.dt', function(e, settings, json) {
      var rows = 0;
      if (sp_table.api().ajax.json() != null) {
        rows = sp_table.api().ajax.json().data.length;
      }
      $('#badge-sp-list').html(rows);
    });

    function refresh_smu_list_table() {
      if (platform.length > 0 && release.length > 0) {
        smu_table.api().ajax.url("/api/get_smu_list/platform/" + platform + "/release/" + release +
          "?filter=" + filter_option).load();
      }
    }

    function refresh_sp_list_table() {
      if (platform.length > 0 && release.length > 0) {
        sp_table.api().ajax.url("/api/get_sp_list/platform/" + platform + "/release/" + release +
          "?filter=" + filter_option).load();
      }
    }
    
    function display_cisco_software_dialog(region_id) {
      current_region_id = region_id;
      read_server_cookie(region_id);
      
      create_menu();
      
      $('#cisco-software-dialog').modal({show:true, backdrop:'static'})
            
      var server_id = $('#hidden_server').val();
      var server_directory = $('#hidden_server_directory').val();
      if (server_id != -1) {
        $('#cisco_dialog_server').val(server_id);
        retrieve_file_list(server_id, $('#cisco_dialog_server_directory'), server_directory);
      }
      
    }

    function create_menu() {
      $.ajax({
        url: "{{ url_for('api_get_catalog') }}",
        dataType: 'json',
        success: function(data) {
          var html = '';

          $.each(data, function(index, element) {
            for (i = 0; i < element.length; i++) {

              var beautified_platform = element[i].beautified_platform
              var platform = element[i].platform;
              var releases = element[i].releases;

              html += '<li class="dropdown-submenu">' +
                '<a href="javascript://">' + beautified_platform + '</a>' +
                '<ul class="dropdown-menu">';

              for (var j = 0; j < releases.length; j++) {
                html += '<li><a class="selected-platform-and-release" href="javascript://" \
                                        platform="' + platform + '" \
                                        release="' + releases[j] + '">' + releases[j] + '</a></li>'
              }

              html += '</ul>' + '</li>'
            }
          });
          $('#dropdown-cisco-menu').html(html);
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          bootbox.alert("Unable to retrieve catalog data");
        }
      });
    }

    $("#dropdown-cisco-menu").on("click", ".selected-platform-and-release", function() {
      platform = $(this).attr('platform');
      release = $(this).attr('release');
      refresh_tables();
    });

    var software_packages = '';

    $('#on-cisco-software-dialog-submit').click(function(e) {
      if ($('#cisco_dialog_server').val() == -1) {
        bootbox.alert("Server Repository has not been specified.");
        return false;
      }     
      
      new_software_packages = [];
      $('.check').each(function(index) {
        if (this.checked) {
          $(this).attr('checked', false);
          new_software_packages.push($(this).val() );
        }
      });

      update_software_packages(new_software_packages);
      
      // Record the newly selected server repository      
      $('#hidden_server').val($('#cisco_dialog_server').val());
      $('#hidden_server_name').val($('#cisco_dialog_server option:selected').text());
      $('#hidden_server_directory').val($('#cisco_dialog_server_directory').val());     
      display_selected_server_info($('#hidden_server_name').val(), $('#hidden_server_directory').val());
      
      write_server_cookie(current_region_id, $('#hidden_server').val(), $('#hidden_server_directory').val());
    });

    // Use delegate pattern for event
    // This happens when the user clicks a pre-requisite/supersedes/superseded by SMU 
    // on the SMU info dialog.
    $("#display-smu-details-dialog").on("click", ".show-smu-hyperlink-details", function() {
      display_smu_details($('#smu-details-table'), $('#smu-name-title'), $(this).attr('smu_id'));
      add_to_history($(this).attr('smu_id'));
    });

    // Use delegate pattern for event
    $("#smu-datatable").on("click", ".show-smu-details", function() {
      display_smu_details_dialog($(this).attr('smu_id'));
    });

    $("#sp-datatable").on("click", ".show-smu-details", function() {
      display_smu_details_dialog($(this).attr('smu_id'));
    });

    function display_smu_details_dialog(smu_id) {
      init_history(smu_id);
      $('#display-smu-details-dialog').modal({
        show: true
      })
      display_smu_details($('#smu-details-table'), $('#smu-name-title'), smu_id)
    }

    $("#move-back").on("click", function() {
      move_back($('#smu-details-table'), $('#smu-name-title'));
    });

    $("#move-forward").on("click", function() {
      move_forward($('#smu-details-table'), $('#smu-name-title'));
    });
    
    function display_selected_server_info(server_name, server_directory) {  
      var html_code = '<span style="color: Gray;"><b>Server Repository:</b></span>&nbsp;' + server_name + '</span>';
      if (server_directory.length > 0) {
        html_code += '<p><span style="color: Gray;"><b>Directory:</b></span>&nbsp;' + server_directory + '</span>';
      }
       
      $('#server-repository-info').html(html_code);
      $('#server-repository-info-panel').removeClass('collapse');
    }
    
    <!--------------------------------------------------------------------------------------------------------------->
    function display_packages(packages) {
      if (packages) {
        return packages.replace(/,/g,"<br/>");
      } else {
        return '&nbsp;';
      }       
    }
  
    var install_history_table = $("#install-history-datatable").dataTable({
      "order": [[ 2, "desc" ]],
      "scrollY": 250,
      "pageLength": 100,
      "columnDefs": [ 
       {
         "targets": 0, 
         "data" : 'packages',
         "render": function ( data, type, row ) {
           return '<input type="checkbox" value="' + data + '" class="check">';
         }
       },
       {
         "targets": 1, 
         "data" : 'packages',
         "render": function ( data, type, row ) {
           return display_packages(data);
         }
       },
       {
         "targets": 2,
         "data" : 'status_time',
         "render": function ( data, type, row ) {
           return convertToLocaleString(data);
         }
       },
       {
         "targets": 3,
         "data" : 'created_by'
       },
      ],
    });
    
    function display_install_history_dialog(hostname_list) {
      initialize_install_history_dialog();
            
      $('#install-history-dialog').modal({show:true, backdrop:'static'})
      if (hostname_list.length == 1) {
        var hostname = hostname_list[0];
        
        $('<option>', {value: hostname, text: hostname, selected: true}).appendTo($('#install_history_dialog_host')); 
        refresh_install_history(hostname)
        
      } else {
        for (i = 0; i < hostname_list.length; i++) {
          $('<option>', {value: hostname_list[i], text: hostname_list[i]}).appendTo($('#install_history_dialog_host')); 
        }
      }
    }
    
    function refresh_install_history(hostname) {
      install_history_table.api().ajax.url("/api/get_install_history/hosts/" + hostname).load();
    }
    
    function initialize_install_history_dialog() {
      $('#install_history_dialog_host').empty();
      $('<option>', {value: '', text: ''}).appendTo($('#install_history_dialog_host')); 
      install_history_table.api().clear().draw();
    }
    
    $('#install_history_dialog_host').on('change', function(e) {
      var selected_host = $('#install_history_dialog_host option:selected').val();
      if (selected_host.length > 0) {
        refresh_install_history(selected_host);
      } 
    }); 
    
    $('#on-install-history-submit').click(function(e) {
      new_software_packages = [];
      $('.check').each(function(index) {
        if (this.checked) {
          $(this).attr('checked', false);
          new_software_packages.push($(this).val());
        }
      }); 
      
      update_software_packages(new_software_packages);
    });
      
    <!--------------------------------------------------------------------------------------------------------------->
    
    $('#inactive_software_dialog_host').on('change', function(e) {
      var selected_host = $('#inactive_software_dialog_host option:selected').val();
      if (selected_host.length > 0) {
        refresh_inactive_software(selected_host);
      } 
    }); 
    
    $('#on-inactive-packages-submit').click(function(e) {
      update_software_packages(inactive_software_selector.get_selected_items());
    });
    
    function update_software_packages(new_software_packages) {
      if (new_software_packages.length == 0) {
        return;
      }
      
      var software_packages = get_software_package_list(); 

      if (software_packages.length > 0) {    
        bootbox.dialog({
          message: "Would you like to append to existing selected software packages?  Click 'Yes' to append or 'No' to override.",
          title: "Confirmation",
          buttons: {
            success: {
              label: "Yes",
              className: "btn-success",
              callback: function() {
                for (i = 0; i < new_software_packages.length; i++) {
                  software_packages.push(new_software_packages[i]);
                }
                $('#software-packages').val(String(software_packages).replace(/,/g, '\n'));
              }
            },
            danger: {
              label: "No",
              className: "btn-danger",
              callback: function() {
                $('#software-packages').val(String(new_software_packages).replace(/,/g, '\n'));
              }
            }, 
          }
        });

      } else {
        $('#software-packages').val(String(new_software_packages).replace(/,/g, '\n'));
      }
    }
  
    var saved_inactive_software = [];
        
    function initialize_inactive_software_dialog() {
      saved_inactive_software = [];
      $('#inactive_software_dialog_host').empty();
      $('<option>', {value: '', text: ''}).appendTo($('#inactive_software_dialog_host')); 
      $('#inactive_software_dialog_last_successful_inventory_elapsed_time').val('');
      inactive_software_selector.initialize([], []);
    }
    
    function display_inactive_software_dialog(hostname_list) {
      initialize_inactive_software_dialog();
      
      $('#inactive-software-dialog').modal({show:true, backdrop:'static'})
            
      if (hostname_list.length == 1) {
        var hostname = hostname_list[0];
        
        $('<option>', {value: hostname, text: hostname, selected: true}).appendTo($('#inactive_software_dialog_host')); 
        refresh_inactive_software(hostname)
        
      } else {
        for (i = 0; i < hostname_list.length; i++) {
          $('<option>', {value: hostname_list[i], text: hostname_list[i]}).appendTo($('#inactive_software_dialog_host')); 
        }
      }
    }
    
    function refresh_inactive_software(hostname) {
      // Update the last successful inventory elapsed time
      $.ajax({
        url: '/api/hosts/' + hostname + '/last_successful_inventory_elapsed_time',  
        dataType: 'json',
        success: function(data) {
          $.each(data, function(index, element) {
            $('#inactive_software_dialog_last_successful_inventory_elapsed_time').val(element[0].last_successful_inventory_elapsed_time);
          });
        }
      });
       
      var inactive_software = []
        
      $.ajax({
        url: '/api/hosts/' + hostname + '/packages/active-committed',  // FIXME: Change back to inactive
        dataType: 'json',
        success: function(data) {
          $.each(data, function(index, element) {
            for (i = 0; i < element.length; i++) {
          
              var software_package = element[i].package;             
              // Remove the location string if exists.
              var n = software_package.search(":"); 
              if (n > 0) {
                software_package = software_package.substring(n + 1);
              }
              
              inactive_software.push({
                'id': software_package,
                'name': software_package
              });
            }
          });
          
          if (!is_same_software(inactive_software) ) {
            inactive_software_selector.initialize(inactive_software);
            save_inactive_software(inactive_software);
          }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          bootbox.alert("Unable to retrieve inactive software. Error=" + errorThrown);
        }
      });      
    }
    
    function is_same_software(inactive_software) {
      for (i = 0; i < inactive_software.length; i++) {
        if ($.inArray(inactive_software[i].name, saved_inactive_software) == -1) {
          return false;
        }
      }
      return (inactive_software.length == saved_inactive_software.length);
    }
    
    function save_inactive_software(inactive_software) {
      saved_inactive_software = [];
      
      for (i = 0; i < inactive_software.length; i++) {
        saved_inactive_software.push(inactive_software[i].name);
      }
    }
    
    var timer = null;
    
    $('#refresh-software').on('click', function(e) {
      var hostname = $('#inactive_software_dialog_host').val();
      if (hostname != null && hostname.length > 0) {
        $.ajax({
          url: '/api/get_software/' + hostname,
          success: function(response) {
            if (response.status == 'OK') {
              refresh_inactive_software(hostname);
            } else {
              bootbox.alert('<img src=\"{{ url_for('static', filename='error.png') }}\">&nbsp;A similar request may be in progress.');
            }
          }
        });
      }
    });
    
    <!--------------------------------------------------------------------------------------------------------------->
    
    function auto_select_software(hostname) {      
      var target_release = $('#server_dialog_target_software').val();
      if (target_release.length == 0) {
        bootbox.alert('Target software release has not been specified.');
        return;
      }   
    
      var target_package_list = [];
    
      $.ajax({
        url: "/api/get_software_package_upgrade_list/hosts/" + hostname + "/release/" + target_release,
        dataType: 'json',
        success: function(data) {
          $.each(data, function(index, element) {
            for (i = 0; i < element.length; i++) {
              target_package_list.push(element[i].package);
            }
          });
        
          if (target_package_list.length > 0) {
            server_software_selector.select_partial_match(target_package_list);
          }
        
          var missing_package_list = [];
          var selected_package_list = server_software_selector.get_selected_items();
          
          for (i = 0; i < target_package_list.length; i++) {
            var target_package = target_package_list[i];
            var found = false;
            for (j = 0; j < selected_package_list.length; j++) {
              var selected_package = selected_package_list[j];
              if (selected_package.indexOf(target_package) > -1) {
                found = true;
                break;
              }
            }  
            
            if (!found) {
              missing_package_list.push(target_package);
            }           
          }
          
          // print error list if any
          if (missing_package_list.length > 0) {
            var package_list = '';
            for (i = 0; i < missing_package_list.length; i++) {
              package_list += missing_package_list[i] + '<br>';
            }
            bootbox.alert("<img src=\"{{ url_for('static', filename='error.png') }}\"> &nbsp;Unable to locate software packages on server repository that match the followings<br><br>" + package_list);
          }
        }
      });
    
    }
    
    $('#inactive-software-dialog').on('shown.bs.modal', function(e) {
      timer = setInterval( function () {
        var hostname = $('#inactive_software_dialog_host').val();
        if (hostname != null && hostname.length > 0) {
          refresh_inactive_software(hostname);
        }
      }, 10000 ); 
    });
    
    $('#inactive-software-dialog').on('hidden.bs.modal', function(e) {
      clearInterval(timer);
    });
  
      
    {% block head_schedule_install %}

    {% endblock head_schedule_install %}
  });
</script>


{% endblock extra_head %}

{% block main %}

<div id="display-smu-details-dialog" class="modal" role="dialog">
  <div class="modal-dialog">
    <form method="post" class="form-horizontal">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">x</button>
          <a href="javascript://">
          <img id="move-back" src="/static/blue_left_arrow.png" title="Go Back">
          <img id="move-forward" src="/static/blue_right_arrow.png" title="Go Forward">
          </a>
          <h4>
            <center><span id="smu-name-title"></span></center>
          </h4>
        </div>
        <div class="modal-body">
          <div style="height:350px; overflow-y: scroll;">
            <table class="table table-striped" id="smu-details-table">
              <thead>
                <tr>
                  <th>Field Name</th>
                  <th>Value</th>
                </tr>
              </thead>
            </table>
          </div>
        </div>
        <div class="modal-footer"> 	     
        </div>
      </div>
    </form>
  </div>
</div>

<div id="server-repository-dialog" class="modal" role="dialog">
  <div class="modal-dialog">
    <form method="post" class="form-horizontal">
      <div class="modal-content">
        <div class="modal-header">

          <button type="button" class="close" data-dismiss="modal">x</button> 
                   
          <h4>Select Software Packages <span id="server-repository-dialog-title"><span></h4>
                               
          {{ edit_field(form.server_dialog_server, field_width="col-sm-7", class="form-control") }}   
          
          {% set extra_field =
            '<a href="javascript://">
            <img id="server-dialog-move-up" src="/static/up_arrow.png" title="Go to Parent Folder">
            <img id="server-dialog-reset-server-directory" src="/static/remove.png" title="Reset Server Directory">
            </a>' 
          %}
            
          {{ edit_field(form.server_dialog_server_directory, field_width="col-sm-7", class="form-control", extra_field=extra_field) }}
                    
        </div>
        <div class="modal-body">
        
          <div id="toggle-auto-select-software" class="collapse">        
            {% set extra_field =
              '<button id="auto-select-software" class="btn">Auto Select</button>' 
            %}       
            {{ edit_field(form.server_dialog_target_software, field_width="col-sm-6", class="form-control", placeholder="Only for Software Upgrade (enter X.X.X format)", extra_field=extra_field) }}  
          </div>
        
          <div class="form-group">           
            <select id="server-software-selector" name="server-software-selector" multiple="multiple" data-title="Packages" data-json=false></select>
          </div>
        </div>
        <span class="browse-spinner">
          <center><img id="spinner" src="{{ url_for('static', filename='spinner.gif') }}"></center>
        </span>
        <div class="modal-footer">
          <div class="form-actions">
            <div class="btn col-sm-offset-4">   
              <button id="on-server-repository-dialog-submit" class="btn btn-primary" data-dismiss="modal">Save</button>
              <button class="btn" data-dismiss="modal">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<div id="cisco-software-dialog" class="modal" role="dialog">
  <div class="modal-dialog">
    <form method="post" class="form-horizontal">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">x</button>
          <div class="form-group ">
            <div class="dropdown col-sm-4">
              <button class="btn btn-default dropdown-toggle" type="button" id="menu1" data-toggle="dropdown">Platforms
              <span class="caret"></span></button>
              <ul id="dropdown-cisco-menu" class="dropdown-menu multi-level" role="menu" aria-labelledby="dropdownMenu"></ul>
            </div>
            
            <div class="col-sm-offset-4 col-sm-3">
              <div class="input-group">
                <span id="filter-icon" title="SMU/Service Pack Filter" class="input-group-addon glyphicon glyphicon-filter"></span>
                <select class="form-control" id="filter-selector" name="filter-selector">
                  <option value="Optimal">Optimal</option>
                  <option value="All">All</option>
                </select>
              </div>
            
            </div>
          </div>
               
          {% set extra_field =    
            '<span class="browse-spinner">
              <img id="spinner" src="/static/spinner.gif">
             </span>'
          %}   
            
          {{ edit_field(form.cisco_dialog_server, field_width="col-sm-7", class="form-control", extra_field=extra_field) }}  
          
          {% set extra_field =
            '<a href="javascript://">
            <img id="cisco-dialog-move-up" src="/static/up_arrow.png" title="Go to Parent Folder">
            <img id="cisco-dialog-reset-server-directory" src="/static/remove.png" title="Reset Server Directory">
            </a>' 
          %}
          
          {{ edit_field(form.cisco_dialog_server_directory, field_width="col-sm-7", class="form-control", extra_field=extra_field) }}   
          
        </div>
        <div class="modal-body">
    
          <!-- upper section -->
          <div class="row">
            <div class="col-sm-12">
              <ul class="nav nav-tabs" id="smu-list-tab">
                <li>
                  <a data-toggle="tab" href="#smu-tab">
                  <span id="platform-and-release">SMUs &nbsp;</span>
                  <span id="badge-smu-list" class="badge alert-success">0</span>
                  </a>
                </li>
                <li>
                  <a data-toggle="tab"  href="#sp-tab">
                  Service Packs &nbsp;
                  <span id="badge-sp-list" class="badge alert-success">0</span>
                  </a>
                </li>
              </ul>
              <div class="tab-content" style="margin-top:20px;">
                <div id="smu-tab" class="tab-pane fade in active">
                  <table class="display table" id="smu-datatable">
                    <thead>
                      <tr>
                        <th>ST</th>
                        <th>Posted Date</th>
                        <th>SMU ID</th>
                        <th>DDTS</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Impact</th>
                        <th>Functional Areas</th>
                        <th>Status</th>
                        <th>Package Bundles</th>
                      </tr>
                    </thead>
                  </table>
                </div>
                <div id="sp-tab" class="tab-pane fade in">
                  <table class="display table" id="sp-datatable">
                    <thead>
                      <tr>
                        <th>ST</th>
                        <th>Posted Date</th>
                        <th>SMU ID</th>
                        <th>DDTS</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Impact</th>
                        <th>Functional Areas</th>
                        <th>Status</th>
                        <th>Package Bundles</th>
                      </tr>
                    </thead>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <!-- /upper section -->
        </div>
        <div class="modal-footer">
          <div class="form-actions">
            <div class="btn col-sm-offset-4">  
   
              <button id="on-cisco-software-dialog-submit" class="btn btn-primary" data-dismiss="modal">Save</button>
              <button class="btn" data-dismiss="modal">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<div id="install-history-dialog" class="modal" role="dialog">
  <div class="modal-dialog">
    <form method="post" class="form-horizontal">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">x</button>
          <h4>Select from Install History</h4>
          {{ edit_field(form.install_history_dialog_host, field_width="col-sm-6", class="form-control") }}  
        </div>
        <div class="modal-body">
          <table class="display table" id="install-history-datatable">
            <thead>
              <tr>
                <th>S</th>
                <th>Packages</th>
                <th>Installed Time</th>
                <th>Installed By</th>
              </tr>
            </thead>
          </table>
        </div>
        <div class="modal-footer">
          <div class="form-actions">
            <div class="btn col-sm-offset-4">   
              <button id="on-install-history-submit" class="btn btn-primary" data-dismiss="modal">Save</button>
              <button class="btn" data-dismiss="modal">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<div id="inactive-software-dialog" class="modal" role="dialog">
  <div class="modal-dialog">
    <form method="post" class="form-horizontal">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">x</button>
          <h4>Select from Inactive Packages</h4>
          {{ edit_field(form.inactive_software_dialog_host, field_width="col-sm-6", class="form-control") }}    
          
          {% set extra_field ='<a href="javascript://" id="refresh-software">
            <img src=\"/static/refresh.png\" title="Retrieve Latest Software"></a>' %}

          {{ edit_field(form.inactive_software_dialog_last_successful_inventory_elapsed_time, readonly=true, field_width="col-sm-6", class="form-control", extra_field=extra_field) }}     
        </div>
        <div class="modal-body">
          <div class="form-group">           
            <select id="inactive-software-selector" name="inactive-software-selector" multiple="multiple" data-title="Inactive-Packages" data-json=false></select>
          </div>
        </div>
        <div class="modal-footer">
          <div class="form-actions">
            <div class="btn col-sm-offset-4">   
              <button id="on-inactive-packages-submit" class="btn btn-primary" data-dismiss="modal">Save</button>
              <button class="btn" data-dismiss="modal">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

{% block main_schedule_install %} {% endblock main_schedule_install %}

{% endblock main %}